#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit hooks..."

# Run lint-staged for file-specific linting and formatting
npx lint-staged

# Run theme.json validation
echo "ğŸ” Validating theme.json..."
if ! node -e "JSON.parse(require('fs').readFileSync('theme.json', 'utf8')); console.log('âœ… theme.json is valid')"; then
  echo "âŒ theme.json validation failed"
  exit 1
fi

# Check for PHP syntax errors
echo "ğŸ” Checking PHP syntax..."
find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" -exec php -l {} \; | grep -v "No syntax errors" && {
  echo "âŒ PHP syntax errors found"
  exit 1
} || echo "âœ… PHP syntax check passed"

# Check for WordPress functions without proper escaping
echo "ğŸ” Checking for unescaped output..."
if grep -r "echo \$\|print \$" --include="*.php" . | grep -v "esc_\|wp_kses\|sanitize_"; then
  echo "âš ï¸  Found potentially unescaped output - review for security"
  echo "ğŸ’¡ Use esc_html(), esc_attr(), esc_url(), or wp_kses() for output escaping"
fi

# Prevent commits to main/master branch
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "âŒ Direct commits to main/master branch are not allowed"
  echo "ğŸ’¡ Create a feature branch: git checkout -b feature/your-feature-name"
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
